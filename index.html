<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GEO EMPIRE - CODEX DARK</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --blue: #00d9ff; --gold: #d4af37; --red: #ff4d4d; --black: #000000; --dark-grey: #0a0a0a; }
        body { background: var(--black); color: #fff; font-family: 'Courier New', monospace; margin: 0; overflow: hidden; }
        
        /* HEADER AVEC TON UNITÉ CODEX */
        .header { background: var(--black); padding: 15px; display: flex; align-items: center; border-bottom: 2px solid var(--blue); box-shadow: 0 0 15px var(--blue); }
        .avatar-codex { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--blue); margin-right: 15px; overflow: hidden; background: #111; }
        .avatar-codex img { width: 100%; height: 100%; object-fit: cover; }
        
        /* RADAR GPS */
        #map { width: 100%; height: 40vh; background: #000; }
        .leaflet-tile-pane { filter: brightness(0.3) invert(1) contrast(3) hue-rotate(180deg); }

        /* DASHBOARD - REGLES PDF */
        .ui { padding: 15px; background: var(--black); height: 60vh; display: flex; flex-direction: column; gap: 10px; border-top: 1px solid #222; overflow-y: auto; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { background: var(--dark-grey); border: 1px solid #222; padding: 10px; border-radius: 4px; position: relative; }
        .label { font-size: 0.6rem; color: #888; text-transform: uppercase; }
        .value { font-size: 1.2rem; font-weight: bold; display: block; }
        .gold { color: var(--gold); }
        
        /* CONSOLE LOGS */
        #console { background: #020202; border-left: 3px solid var(--blue); padding: 8px; font-size: 0.7rem; color: #00ff00; height: 70px; overflow-y: auto; margin-bottom: 5px; }

        /* BOUTONS ACTIONS */
        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 15px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; border-radius: 4px; font-size: 0.8rem; }
        .btn-buy { background: var(--blue); color: #000; }
        .btn-sell { background: transparent; border: 1px solid var(--red); color: var(--red); }
        
        .timer { font-size: 0.8rem; color: var(--gold); text-align: right; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="header">
    <div class="avatar-codex">
        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Codex" alt="IA">
    </div>
    <div style="flex-grow:1;">
        <div style="color: var(--blue); font-weight: bold;">CODEX UNIT v1.0</div>
        <div id="gps-status" style="font-size: 0.6rem; color: #555;">SCANNER SATELLITE...</div>
    </div>
    <div class="timer" id="clock">00:00:00</div>
</div>

<div id="map"></div>

<div class="ui">
    <div id="console">> Initialisation du système...<br>> Chargement des règles PDF...</div>

    <div class="stats-grid">
        <div class="card" style="grid-column: span 2;">
            <span class="label">Trésorerie Holding (Cash)</span>
            <span id="cash" class="value gold">10 000 Ø</span>
        </div>
        <div class="card">
            <span class="label">Patrimoine Brut</span>
            <span id="patrimoine" class="value">0 Ø</span>
        </div>
        <div class="card">
            <span class="label">Limite Découvert (50%)</span>
            <span id="limite" class="value" style="color: var(--red);">0 Ø</span>
        </div>
    </div>

    <div class="actions">
        <button class="btn btn-buy" onclick="ordreAchat()">ACHETER (5 km)</button>
        <button class="btn btn-sell" onclick="ordreVente()">ORDRE VENTE</button>
    </div>
    
    <div style="font-size: 0.6rem; color: #444; text-align: center;">
        REVENUS ET TRANSACTIONS EFFECTUÉS À MINUIT (RÈGLE PAGE 2 PDF)
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- DATA INITIALE (MEMOIRE PDF) ---
    let cash = 10000;
    let patrimoine = 0;
    let ordresEnAttente = [];
    const TAUX_DECOUVERT = 0.50; // 50% selon PDF

    // Initialisation Map Dark
    var map = L.map('map', {zoomControl: false}).setView([45.858, 1.305], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function log(msg) {
        const c = document.getElementById('console');
        c.innerHTML = "> " + msg + "<br>" + c.innerHTML;
    }

    // HORLOGE TEMPS REEL (PAGE 23 PDF)
    function updateClock() {
        let now = new Date();
        let h = now.getHours();
        let m = now.getMinutes();
        let s = now.getSeconds();
        document.getElementById('clock').innerText = 
            (h<10?'0':'')+h+":"+(m<10?'0':'')+m+":"+(s<10?'0':'')+s;
        
        // Règle de Minuit
        if(h === 0 && m === 0 && s === 0) {
            traiterTransfertMinuit();
        }
    }
    setInterval(updateClock, 1000);

    // GPS & ENTREPRISES REELLES
    function startGPS() {
        map.locate({setView: true, maxZoom: 16});
    }
    map.on('locationfound', function(e) {
        log("GPS OK. Rayon 5km activé.");
        document.getElementById('gps-status').innerText = "RADAR ACTIF - LE PALAIS SUR VIENNE";
        L.circle(e.latlng, {radius: 50, color: '#00d9ff'}).addTo(map);
        
        // Simuler entreprises réelles détectées
        log("Cibles détectées : Mairie, Pharmacie, Poste.");
    });

    // MECANIQUE ACHAT (PDF PAGE 2)
    function ordreAchat() {
        if(cash >= 5000) {
            let pos = map.getCenter();
            ordresEnAttente.push({type: 'ACHAT', pos: pos, prix: 5000});
            log("ORDRE D'ACHAT ENREGISTRÉ. Validation à Minuit.");
            L.circleMarker(pos, {radius: 10, color: '#d4af37'}).addTo(map)
             .bindPopup("Achat en attente de minuit...");
        } else {
            log("CASH INSUFFISANT.");
        }
    }

    // MECANIQUE MINUIT (PDF PAGE 22-23)
    function traiterTransfertMinuit() {
        log("00:00 - TRAITEMENT DU BILAN JOURNALIER...");
        ordresEnAttente.forEach(ordre => {
            if(ordre.type === 'ACHAT') {
                cash -= ordre.prix;
                patrimoine += ordre.prix;
            }
        });
        ordresEnAttente = [];
        updateUI();
        verifierBanqueroute();
    }

    function verifierBanqueroute() {
        let limite = -(patrimoine * TAUX_DECOUVERT);
        if(cash < limite) {
            log("ALERTE : LIQUIDATION FORCÉE (DECOUVERT > 50%)");
        }
    }

    function updateUI() {
        document.getElementById('cash').innerText = cash.toLocaleString() + " Ø";
        document.getElementById('patrimoine').innerText = patrimoine.toLocaleString() + " Ø";
        document.getElementById('limite').innerText = (-(patrimoine * 0.5)).toLocaleString() + " Ø";
    }

    setTimeout(startGPS, 1000);
</script>
</body>
</html>
